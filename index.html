<!DOCTYPE html>
<html lang="en">
<head>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2654/2654504.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Forecast Pro</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; background-color: #fdfaf5; }
        .paid-item { opacity: 0.6; }
        .paid-text { text-decoration: line-through; }
        .scheduled-item { border-left: 4px solid #f59e0b; }
        .custom-card { border-radius: 1.5rem; }
        input[type="date"], select { cursor: pointer; }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- Utilities ---
        const ANCHOR_DATE = new Date(2026, 0, 9, 0, 0, 0, 0);
        const toDateStr = (date) => date.toISOString().split('T')[0];
        const parseDate = (str) => {
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d, 0, 0, 0, 0);
        };

        const getAlignedStartDate = (date, mode) => {
            const d = new Date(date);
            if (mode === 'monthly') return new Date(d.getFullYear(), d.getMonth(), 1);
            const diff = Math.floor((d - ANCHOR_DATE) / (1000 * 60 * 60 * 24));
            const offset = mode === 'weekly' ? 7 : 14;
            const periodsSinceAnchor = Math.floor(diff / offset);
            const aligned = new Date(ANCHOR_DATE);
            aligned.setDate(aligned.getDate() + (periodsSinceAnchor * offset));
            return aligned;
        };

        const calculateEnd = (startDate, mode) => {
            let d = parseDate(startDate);
            if (mode === 'weekly') d.setDate(d.getDate() + 6);
            else if (mode === 'biweekly') d.setDate(d.getDate() + 13);
            else d = new Date(d.getFullYear(), d.getMonth() + 1, 0);
            return toDateStr(d);
        };

        const CATEGORY_MAP = {
            'Housing': '#3b82f6', 'Utilities': '#06b6d4', 'Food': '#10b981', 
            'Transport': '#6366f1', 'Pets': '#f97316', 'Personal/Beauty': '#ec4899', 
            'Entertainment': '#8b5cf6', 'Insurance': '#71717a', 'Savings': '#14b8a6', 
            'Income': '#22c55e', 'General': '#94a3b8'
        };

        const getCatColor = (cat, idx) => CATEGORY_MAP[cat] || ['#f43f5e', '#a855f7', '#eab308', '#0ea5e9'][idx % 4];

        // --- Components ---
        const Icon = ({ name, size = 18, className = "" }) => {
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return (
                <span className={`inline-flex items-center justify-center pointer-events-none ${className}`}>
                    <i data-lucide={name} style={{width: size, height: size}}></i>
                </span>
            );
        };

        const App = () => {
            const [tab, setTab] = React.useState('list'); 
            const [analyticsView, setAnalyticsView] = React.useState('period'); 
            const [viewMode, setViewMode] = React.useState(localStorage.getItem('bfp_viewMode') || 'biweekly'); 
            
            const safeParse = (key, fallback) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : fallback;
                } catch (e) { return fallback; }
            };

            const [items, setItems] = React.useState(() => safeParse('bfp_items', []));
            const [paid, setPaid] = React.useState(() => safeParse('bfp_paid', {}));
            const [overrides, setOverrides] = React.useState(() => safeParse('bfp_overrides', {}));
            const [hidden, setHidden] = React.useState(() => safeParse('bfp_hidden', {})); 
            const [customCats, setCustomCats] = React.useState(() => safeParse('bfp_customCats', []));
            const [backupText, setBackupText] = React.useState('');
            const [lastBackup, setLastBackup] = React.useState(localStorage.getItem('last_backup_date') || null);
            const [saveStatus, setSaveStatus] = React.useState('saved');

            const expenseListEndRef = React.useRef(null);

            const [start, setStart] = React.useState(toDateStr(getAlignedStartDate(new Date(), viewMode)));
            const [end, setEnd] = React.useState(calculateEnd(start, viewMode));

            const navigatePeriod = (direction) => {
                const d = parseDate(start);
                if (viewMode === 'weekly') d.setDate(d.getDate() + (direction * 7));
                else if (viewMode === 'biweekly') d.setDate(d.getDate() + (direction * 14));
                else d.setMonth(d.getMonth() + direction, 1);
                const nextStart = toDateStr(d);
                setStart(nextStart);
                setEnd(calculateEnd(nextStart, viewMode));
            };

            React.useEffect(() => {
                const aligned = getAlignedStartDate(parseDate(start), viewMode);
                setStart(toDateStr(aligned));
                setEnd(calculateEnd(toDateStr(aligned), viewMode));
                localStorage.setItem('bfp_viewMode', viewMode);
            }, [viewMode]);

            const save = (l, p, o, h, c) => {
                setSaveStatus('saving');
                if (l !== undefined) { setItems(l); localStorage.setItem('bfp_items', JSON.stringify(l)); }
                if (p !== undefined) { setPaid(p); localStorage.setItem('bfp_paid', JSON.stringify(p)); }
                if (o !== undefined) { setOverrides(o); localStorage.setItem('bfp_overrides', JSON.stringify(o)); }
                if (h !== undefined) { setHidden(h); localStorage.setItem('bfp_hidden', JSON.stringify(h)); }
                if (c !== undefined) { setCustomCats(c); localStorage.setItem('bfp_customCats', JSON.stringify(c)); }
                setTimeout(() => setSaveStatus('saved'), 300);
            };

            const addItem = (type) => {
                const newList = [...items, { id: Date.now(), type, name: '', amount: 0, freq: 'Monthly', day: 1, dow: 'Friday', ref: toDateStr(new Date()), endDate: '', category: 'General' }];
                save(newList);
                setTimeout(() => { expenseListEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, 100);
            };

            const generateInstances = (dStart, dEnd) => {
                const instances = [];
                items.forEach(item => {
                    let curr = new Date(dStart);
                    curr.setDate(curr.getDate() - 31);
                    const itemEnd = item.endDate ? parseDate(item.endDate) : null;
                    const itemRef = item.ref ? parseDate(item.ref) : null;
                    while (curr <= dEnd) {
                        if (itemEnd && curr > itemEnd) break;
                        let hit = false;
                        if (item.freq === 'One-Time' && itemRef && curr.getTime() === itemRef.getTime()) hit = true;
                        if (item.freq === 'Weekly' && ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][curr.getDay()] === item.dow) hit = true;
                        if (item.freq === 'Monthly' && curr.getDate() === parseInt(item.day)) hit = true;
                        if (item.freq === 'Bi-Weekly' && itemRef) {
                            const diff = Math.round((curr - itemRef) / 86400000);
                            if (diff >= 0 && diff % 14 === 0) hit = true;
                        }
                        if (item.freq === 'Quarterly' && itemRef) {
                            const mths = (curr.getFullYear() - itemRef.getFullYear()) * 12 + (curr.getMonth() - itemRef.getMonth());
                            if (mths >= 0 && mths % 3 === 0 && curr.getDate() === itemRef.getDate()) hit = true;
                        }
                        if (hit && curr >= dStart) {
                            const dStr = toDateStr(curr);
                            const k = item.id + '-' + dStr;
                            if (!hidden[k]) {
                                instances.push({ 
                                    ...item, date: overrides[k]?.moveDate || dStr, key: k, originalDate: dStr,
                                    amount: parseFloat(overrides[k]?.amount !== undefined ? overrides[k].amount : item.amount) || 0,
                                    status: paid[k] === true ? 'paid' : paid[k],
                                    name: overrides[k]?.name !== undefined ? overrides[k].name : item.name,
                                    note: overrides[k]?.note || '',
                                    showNote: overrides[k]?.showNote || false
                                });
                            }
                        }
                        curr.setDate(curr.getDate() + 1);
                    }
                });
                return instances;
            };

            const groupedForecast = React.useMemo(() => {
                const instances = generateInstances(parseDate(start), parseDate(end));
                instances.sort((a,b) => a.date.localeCompare(b.date));
                const groups = [];
                let ptr = new Date(parseDate(start));
                while (ptr <= parseDate(end)) {
                    let pEnd = new Date(ptr);
                    if (viewMode === 'weekly') pEnd.setDate(ptr.getDate() + 6);
                    else if (viewMode === 'biweekly') pEnd.setDate(ptr.getDate() + 13);
                    else pEnd = new Date(ptr.getFullYear(), ptr.getMonth() + 1, 0);
                    const matches = instances.filter(i => { const d = parseDate(i.date); return d >= ptr && d <= pEnd; });
                    const inc = matches.filter(x => x.type === 'income').reduce((a, b) => a + b.amount, 0);
                    const exp = matches.filter(x => x.type === 'expense').reduce((a, b) => a + b.amount, 0);
                    groups.push({ 
                        title: viewMode === 'monthly' ? ptr.toLocaleDateString(undefined, { month: 'long', year: 'numeric' }) : (viewMode === 'biweekly' ? `Pay Period (${ptr.toLocaleDateString()})` : `Week of ${ptr.toLocaleDateString()}`), 
                        items: matches, inc, exp, net: inc - exp,
                        sPaid: matches.filter(x => x.type === 'expense' && x.status === 'paid').reduce((a,b) => a + b.amount, 0),
                        sSched: matches.filter(x => x.type === 'expense' && x.status === 'scheduled').reduce((a,b) => a + b.amount, 0),
                        sRem: matches.filter(x => x.type === 'expense' && !x.status).reduce((a,b) => a + b.amount, 0)
                    });
                    ptr = new Date(pEnd); ptr.setDate(ptr.getDate() + 1);
                }
                return groups;
            }, [items, start, end, overrides, hidden, viewMode, paid]);

            const yearlyData = React.useMemo(() => {
                const instances = generateInstances(new Date(2026, 0, 1), new Date(2026, 11, 31));
                const exp = instances.filter(i => i.type === 'expense');
                const catTotals = exp.reduce((acc, i) => { acc[i.category] = (acc[i.category] || 0) + i.amount; return acc; }, {});
                const monthlyTrend = Array.from({length: 12}, (_, m) => ({
                    month: new Date(2026, m).toLocaleDateString(undefined, {month: 'short'}),
                    amount: exp.filter(i => parseDate(i.date).getMonth() === m).reduce((a,b) => a + b.amount, 0)
                }));
                return { totalExp: exp.reduce((a,b) => a + b.amount, 0), totalInc: instances.filter(i => i.type === 'income').reduce((a,b) => a + b.amount, 0), catTotals, monthlyTrend };
            }, [items, overrides, hidden]);

            const currentTotals = React.useMemo(() => {
                return groupedForecast.reduce((acc, g) => ({
                    paid: acc.paid + g.sPaid, scheduled: acc.scheduled + g.sSched, remaining: acc.remaining + g.sRem, income: acc.income + g.inc
                }), { paid: 0, scheduled: 0, remaining: 0, income: 0 });
            }, [groupedForecast]);

            return (
                <div className="min-h-screen pb-24">
                    <header className="bg-white/80 backdrop-blur-md border-b p-4 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <h1 className="font-black text-xl flex items-center gap-2 text-sky-900">
                                <span className="bg-sky-500 text-white p-1.5 rounded-xl flex items-center justify-center shadow-md"><Icon name="line-chart" /></span>
                                Budget Forecast <span className="text-sky-500">Pro</span>
                            </h1>
                            <div className="bg-stone-200/50 p-1 rounded-2xl flex gap-1">
                                {['list', 'forecast', 'analytics', 'backup'].map(t => (
                                    <button key={t} onClick={() => setTab(t)} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-wider transition-all ${tab === t ? 'bg-white shadow text-sky-600' : 'text-stone-500 hover:text-stone-700'}`}>
                                        {t === 'list' ? 'Standing List' : t === 'backup' ? 'Backups' : t === 'analytics' ? 'Analytics' : 'Forecast'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 md:p-6">
                        {tab === 'list' && (
                            <div className="space-y-10">
                                <section className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-white p-6 rounded-[2rem] border border-stone-200 shadow-sm text-center">
                                        <h3 className="text-[10px] font-black text-stone-400 uppercase mb-4 tracking-widest">Default Forecast View</h3>
                                        <div className="flex gap-2">
                                            {['weekly', 'biweekly', 'monthly'].map(m => (
                                                <button key={m} onClick={() => setViewMode(m)} className={`flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all ${viewMode === m ? 'bg-sky-600 text-white shadow-lg' : 'bg-stone-50 text-stone-400 border border-stone-100'}`}>{m === 'biweekly' ? 'Bi-Weekly' : m}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-[2rem] border border-stone-200 shadow-sm text-center">
                                        <h3 className="text-[10px] font-black text-stone-400 uppercase mb-4 tracking-widest">Custom Category</h3>
                                        <div className="flex gap-2">
                                            <input id="newCatIn" className="flex-1 bg-stone-50 border border-stone-100 rounded-xl px-4 py-2 text-xs outline-none" placeholder="e.g. Vacation" />
                                            <button onClick={() => { const el = document.getElementById('newCatIn'); if(el.value){ save(undefined, undefined, undefined, undefined, [...customCats, el.value]); el.value = ''; } }} className="bg-stone-800 text-white px-4 rounded-xl text-[10px] font-black uppercase">Add</button>
                                        </div>
                                    </div>
                                </section>
                                <section>
                                    <h2 className="font-black text-2xl uppercase tracking-tight text-emerald-800 mb-6">Income Rules</h2>
                                    <div className="space-y-3">{items.filter(i => i.type === 'income').map(i => (<StandingItemRow key={i.id} item={i} onUpdate={(id,f,v) => save(items.map(x=>x.id===id?{...x,[f]:v}:x))} onRemove={() => save(items.filter(x=>x.id!==i.id))} days={['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']} cats={[...Object.keys(CATEGORY_MAP), ...customCats]} colorFunc={getCatColor} />))}</div>
                                    <button onClick={() => addItem('income')} className="mt-4 bg-emerald-600 px-5 py-2.5 rounded-xl text-white text-xs font-black">+ Add Income</button>
                                </section>
                                <section>
                                    <h2 className="font-black text-2xl uppercase tracking-tight text-rose-800 mb-6">Expense Rules</h2>
                                    <button onClick={() => addItem('expense')} className="mb-6 bg-rose-600 px-5 py-2.5 rounded-xl text-white text-xs font-black">+ Add Expense</button>
                                    <div className="space-y-3">
                                        {items.filter(i => i.type === 'expense').map(i => (<StandingItemRow key={i.id} item={i} onUpdate={(id,f,v) => save(items.map(x=>x.id===id?{...x,[f]:v}:x))} onRemove={() => save(items.filter(x=>x.id!==i.id))} days={['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']} cats={[...Object.keys(CATEGORY_MAP), ...customCats]} colorFunc={getCatColor} />))}
                                        <div ref={expenseListEndRef} className="pt-2"><button onClick={() => addItem('expense')} className="w-full border-2 border-dashed border-stone-200 rounded-[2rem] py-6 text-stone-400 font-black uppercase text-[10px] tracking-widest">+ Add New Rule</button></div>
                                    </div>
                                </section>
                            </div>
                        )}

                        {tab === 'forecast' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 custom-card border shadow-sm border-stone-200 space-y-6">
                                    <div className="flex flex-col md:flex-row justify-between items-center gap-6">
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => navigatePeriod(-1)} className="p-3 bg-stone-100 rounded-xl"><Icon name="chevron-left" size={24} /></button>
                                            <div className="text-center px-4">
                                                <p className="text-lg font-bold text-sky-900">{parseDate(start).toLocaleDateString(undefined, {month: 'short', day: 'numeric'})} — {parseDate(end).toLocaleDateString(undefined, {month: 'short', day: 'numeric', year: 'numeric'})}</p>
                                            </div>
                                            <button onClick={() => navigatePeriod(1)} className="p-3 bg-stone-100 rounded-xl"><Icon name="chevron-right" size={24} /></button>
                                        </div>
                                        
                                        {/* New Period Summary Grid */}
                                        <div className="flex-1 grid grid-cols-3 gap-2 w-full md:max-w-md">
                                            <div className="bg-emerald-50 p-3 rounded-2xl text-center border border-emerald-100">
                                                <span className="block text-[8px] font-black text-emerald-500 uppercase tracking-wider">Income</span>
                                                <span className="text-emerald-700 font-black text-sm">${currentTotals.income.toLocaleString()}</span>
                                            </div>
                                            <div className="bg-rose-50 p-3 rounded-2xl text-center border border-rose-100">
                                                <span className="block text-[8px] font-black text-rose-500 uppercase tracking-wider">Expenses</span>
                                                <span className="text-rose-700 font-black text-sm">${(currentTotals.paid + currentTotals.scheduled + currentTotals.remaining).toLocaleString()}</span>
                                            </div>
                                            <div className="bg-sky-50 p-3 rounded-2xl text-center border border-sky-100">
                                                <span className="block text-[8px] font-black text-sky-500 uppercase tracking-wider">Remaining</span>
                                                <span className={`font-black text-sm ${currentTotals.income - (currentTotals.paid + currentTotals.scheduled + currentTotals.remaining) >= 0 ? 'text-sky-700' : 'text-rose-700'}`}>
                                                    ${(currentTotals.income - (currentTotals.paid + currentTotals.scheduled + currentTotals.remaining)).toLocaleString()}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-3 gap-2 pt-4 border-t border-stone-100 text-center">
                                        <div className="bg-stone-50 p-3 rounded-2xl"><span className="block text-[9px] font-black text-sky-400 uppercase">Paid</span><span className="text-sky-700 font-black text-sm">${currentTotals.paid.toLocaleString()}</span></div>
                                        <div className="bg-stone-50 p-3 rounded-2xl"><span className="block text-[9px] font-black text-amber-400 uppercase">Sched</span><span className="text-amber-700 font-black text-sm">${currentTotals.scheduled.toLocaleString()}</span></div>
                                        <div className="bg-stone-50 p-3 rounded-2xl"><span className="block text-[9px] font-black text-stone-400 uppercase">Rem</span><span className="text-stone-700 font-black text-sm">${currentTotals.remaining.toLocaleString()}</span></div>
                                    </div>
                                </div>
                                {groupedForecast.map((group, idx) => group.items.length > 0 && (
                                    <div key={idx} className="bg-white rounded-[2rem] border border-stone-200 overflow-hidden shadow-sm">
                                        <div className="px-6 py-4 bg-stone-50 border-b border-stone-200 flex justify-between items-center">
                                            <span className="font-black text-xs uppercase text-sky-800 tracking-widest">{group.title}</span>
                                        </div>
                                        <div className="divide-y divide-stone-100">
                                            {group.items.map(i => {
                                                const hasNote = i.note && i.note.length > 0;
                                                return (
                                                    <div key={i.key} className={`flex flex-col px-6 py-4 ${i.status === 'paid' ? 'paid-item bg-stone-50/40' : i.status === 'scheduled' ? 'scheduled-item bg-amber-50/20' : 'hover:bg-sky-50/30'} group transition-all`}>
                                                        <div className="flex items-center gap-4">
                                                            <button onClick={() => {
                                                                const k = i.key; const cur = paid[k] === true ? 'paid' : paid[k];
                                                                let next = cur === 'scheduled' ? 'paid' : cur === 'paid' ? null : 'scheduled';
                                                                save(undefined, { ...paid, [k]: next });
                                                            }} className={i.status === 'paid' ? 'text-sky-600' : i.status === 'scheduled' ? 'text-amber-500' : 'text-stone-300'}><Icon name={i.status === 'paid' ? 'check-circle-2' : i.status === 'scheduled' ? 'calendar-clock' : 'circle'} size={28} /></button>
                                                            <div className="flex-1">
                                                                <input className={`w-full font-bold text-lg bg-transparent border-none outline-none ${i.status === 'paid' ? 'paid-text text-stone-400' : 'text-slate-900'}`} value={i.name} onChange={(e) => {
                                                                    const newO = { ...overrides, [i.key]: { ...(overrides[i.key] || {}), name: e.target.value } };
                                                                    save(undefined, undefined, newO);
                                                                }} />
                                                                <p className="text-[10px] font-bold text-stone-400 uppercase flex items-center gap-2">
                                                                    {parseDate(i.date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}
                                                                    {i.status === 'scheduled' && <span className="px-1 py-0.5 bg-amber-100 text-amber-700 rounded text-[9px]">Scheduled</span>}
                                                                    {i.status === 'paid' && <span className="px-1 py-0.5 bg-sky-100 text-sky-700 rounded text-[9px]">Paid</span>}
                                                                    {i.date !== i.originalDate && <span className="text-amber-600 italic">(Shifted)</span>}
                                                                    <span className="italic opacity-60" style={{ color: getCatColor(i.category, 0) }}>• {i.category}</span>
                                                                </p>
                                                            </div>
                                                            <div className="flex items-center gap-2 bg-stone-50 px-3 py-1.5 rounded-xl border border-stone-100">
                                                                <span className="text-stone-400 font-bold">$</span>
                                                                <input type="number" className={`w-20 font-black text-right bg-transparent outline-none ${i.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}`} value={i.amount || ''} onChange={(e) => {
                                                                    const newO = { ...overrides, [i.key]: { ...(overrides[i.key] || {}), amount: e.target.value } };
                                                                    save(undefined, undefined, newO);
                                                                }} />
                                                            </div>
                                                            <div className="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button title="Shift Date" className="p-2 text-stone-400 hover:text-sky-600 relative"><Icon name="calendar-range" size={18} /><input type="date" className="absolute inset-0 opacity-0 cursor-pointer" value={i.date} onChange={(e) => {
                                                                    const newO = { ...overrides, [i.key]: { ...(overrides[i.key] || {}), moveDate: e.target.value } };
                                                                    save(undefined, undefined, newO);
                                                                }} /></button>
                                                                <button title="Memo" onClick={() => {
                                                                    const newO = { ...overrides, [i.key]: { ...(overrides[i.key] || {}), showNote: !i.showNote } };
                                                                    save(undefined, undefined, newO);
                                                                }} className={`p-2 ${hasNote ? 'text-sky-600' : 'text-stone-400'}`}><Icon name="sticky-note" size={18} /></button>
                                                                <button onClick={() => save(undefined, undefined, undefined, { ...hidden, [i.key]: true })} className="p-2 text-stone-300 hover:text-rose-500"><Icon name="trash-2" size={18} /></button>
                                                            </div>
                                                        </div>
                                                        {(i.showNote || hasNote) && <div className="mt-2 pl-12"><input className="w-full text-xs bg-stone-100/50 p-2 rounded-lg outline-none text-stone-600 italic border border-stone-200" value={i.note} onChange={(e) => {
                                                                const newO = { ...overrides, [i.key]: { ...(overrides[i.key] || {}), note: e.target.value } };
                                                                save(undefined, undefined, newO);
                                                            }} placeholder="Type a note..." /></div>}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {tab === 'analytics' && (
                            <div className="space-y-6">
                                <div className="bg-white p-2 rounded-2xl border border-stone-200 shadow-sm flex gap-1 max-w-xs mx-auto">
                                    <button onClick={() => setAnalyticsView('period')} className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${analyticsView === 'period' ? 'bg-sky-600 text-white shadow-md' : 'text-stone-400 hover:bg-stone-50'}`}>Period</button>
                                    <button onClick={() => setAnalyticsView('yearly')} className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${analyticsView === 'yearly' ? 'bg-sky-600 text-white shadow-md' : 'text-stone-400 hover:bg-stone-50'}`}>Yearly (2026)</button>
                                </div>
                                <div className="bg-white p-8 custom-card border border-stone-200 shadow-sm">
                                    <div className="text-center mb-8">
                                        <h2 className="font-black text-2xl uppercase text-sky-900">{analyticsView === 'yearly' ? 'Full 2026 Projection' : 'Period Spending'}</h2>
                                        <p className="text-stone-400 text-[10px] font-black uppercase tracking-widest">{analyticsView === 'yearly' ? 'Jan 1 — Dec 31, 2026' : `${parseDate(start).toLocaleDateString()} — ${parseDate(end).toLocaleDateString()}`}</p>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10 text-center">
                                        <div className="bg-emerald-50 p-4 rounded-3xl"><span className="block text-[9px] font-black text-emerald-500 uppercase mb-1">Total Income</span><span className="text-xl font-black text-emerald-700">${(analyticsView === 'yearly' ? yearlyData.totalInc : currentTotals.income).toLocaleString()}</span></div>
                                        <div className="bg-rose-50 p-4 rounded-3xl"><span className="block text-[9px] font-black text-rose-500 uppercase mb-1">Total Expenses</span><span className="text-xl font-black text-rose-700">${(analyticsView === 'yearly' ? yearlyData.totalExp : (currentTotals.paid + currentTotals.scheduled + currentTotals.remaining)).toLocaleString()}</span></div>
                                        <div className="bg-sky-50 p-4 rounded-3xl"><span className="block text-[9px] font-black text-sky-500 uppercase mb-1">Net Savings</span><span className="text-xl font-black text-sky-700">${(analyticsView === 'yearly' ? (yearlyData.totalInc - yearlyData.totalExp) : (currentTotals.income - (currentTotals.paid + currentTotals.scheduled + currentTotals.remaining))).toLocaleString()}</span></div>
                                    </div>

                                    <div className="flex flex-col md:flex-row items-center justify-around gap-12">
                                        <div className="relative w-64 h-64">
                                            {(() => {
                                                const sourceData = analyticsView === 'yearly' ? yearlyData.catTotals : groupedForecast.flatMap(g => g.items).filter(i => i.type === 'expense').reduce((acc, i) => { acc[i.category] = (acc[i.category] || 0) + i.amount; return acc; }, {});
                                                const total = Object.values(sourceData).reduce((a,b)=>a+b, 0);
                                                let cumulative = 0;
                                                if (total === 0) return <div className="w-full h-full rounded-full border-4 border-dashed border-stone-100 flex items-center justify-center text-stone-300 uppercase font-black text-xs">No Data</div>;
                                                return (
                                                    <svg viewBox="0 0 32 32" className="w-full h-full transform -rotate-90">
                                                        {Object.entries(sourceData).map(([cat, val], idx) => {
                                                            const percent = (val / total) * 100;
                                                            const offset = -cumulative; cumulative += percent;
                                                            return <circle key={cat} r="16" cx="16" cy="16" fill="transparent" stroke={getCatColor(cat, idx)} strokeWidth="32" strokeDasharray={`${percent} 100`} strokeDashoffset={offset} />;
                                                        })}
                                                        <circle r="12" cx="16" cy="16" fill="white" />
                                                    </svg>
                                                );
                                            })()}
                                            <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-center">
                                                <span className="text-[10px] font-black text-stone-400 uppercase leading-none">Total Out</span>
                                                <span className="text-xl font-black text-sky-900">${(analyticsView === 'yearly' ? yearlyData.totalExp : (currentTotals.paid + currentTotals.scheduled + currentTotals.remaining)).toLocaleString()}</span>
                                            </div>
                                        </div>
                                        <div className="flex-1 space-y-3 w-full max-w-sm">
                                            {Object.entries(analyticsView === 'yearly' ? yearlyData.catTotals : groupedForecast.flatMap(g => g.items).filter(i => i.type === 'expense').reduce((acc, i) => { acc[i.category] = (acc[i.category] || 0) + i.amount; return acc; }, {}))
                                                .sort((a,b) => b[1] - a[1]).map(([cat, val], idx) => {
                                                    const total = analyticsView === 'yearly' ? yearlyData.totalExp : (currentTotals.paid + currentTotals.scheduled + currentTotals.remaining);
                                                    return (
                                                        <div key={cat} className="flex items-center justify-between p-2 rounded-xl bg-stone-50/50">
                                                            <div className="flex items-center gap-3"><div className="w-3 h-3 rounded-full" style={{ backgroundColor: getCatColor(cat, idx) }}></div><span className="text-xs font-black text-slate-700 uppercase">{cat}</span></div>
                                                            <div className="text-right">
                                                                <span className="text-xs font-black text-slate-900 block">${val.toLocaleString()}</span>
                                                                <span className="text-[9px] font-bold text-stone-400">{Math.round((val/total)*100)}%</span>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    </div>

                                    {analyticsView === 'yearly' && (
                                        <div className="mt-12 pt-10 border-t border-stone-100">
                                            <h3 className="text-[10px] font-black text-stone-400 uppercase mb-6 tracking-widest text-center">2026 Monthly Spending Trend</h3>
                                            <div className="flex items-end justify-between h-32 gap-1 px-4">
                                                {yearlyData.monthlyTrend.map((m, idx) => {
                                                    const max = Math.max(...yearlyData.monthlyTrend.map(x => x.amount)) || 1;
                                                    const height = (m.amount / max) * 100;
                                                    return (
                                                        <div key={idx} className="flex-1 flex flex-col items-center gap-2 group">
                                                            <div className="w-full bg-sky-500/10 rounded-t-lg relative transition-all group-hover:bg-sky-500/20" style={{ height: `${height}%` }}>
                                                                <div className="absolute -top-6 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 bg-slate-900 text-white text-[8px] font-black p-1 rounded transition-opacity pointer-events-none whitespace-nowrap">${Math.round(m.amount).toLocaleString()}</div>
                                                            </div>
                                                            <span className="text-[9px] font-black text-stone-400 uppercase">{m.month}</span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {tab === 'backup' && (
                            <div className="space-y-8 max-w-2xl mx-auto">
                                <section className="bg-white p-8 rounded-[2.5rem] border border-stone-200 shadow-sm text-center">
                                    <Icon name="download" size={24} className="mb-4" />
                                    <button onClick={() => {
                                        const data = JSON.stringify({items, paid, overrides, hidden, viewMode, customCats}, null, 2);
                                        const blob = new Blob([data], {type: 'application/json'});
                                        const url = URL.createObjectURL(blob);
                                        const link = document.createElement('a');
                                        link.download = `Budget_Backup_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
                                        link.href = url;
                                        link.click();
                                        localStorage.setItem('last_backup_date', new Date().toISOString());
                                        setLastBackup(new Date().toISOString());
                                    }} className="w-full bg-sky-600 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg flex items-center justify-center gap-2 mb-4"><Icon name="file-json" size={16} /> Export Budget (.json)</button>
                                    <textarea className="w-full bg-stone-50 border border-stone-200 rounded-2xl px-4 py-3 font-mono text-xs outline-none" rows="4" value={backupText} onChange={e => setBackupText(e.target.value)} placeholder="Paste JSON here..." />
                                    <button onClick={() => { try { const d = JSON.parse(backupText); save(d.items || [], d.paid || {}, d.overrides || {}, d.hidden || {}, d.customCats || []); alert("Restored!"); } catch(e) { alert("Invalid JSON."); } }} className="w-full mt-3 bg-stone-800 text-white py-3.5 rounded-2xl font-black uppercase text-xs">Restore Data</button>
                                </section>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const StandingItemRow = ({ item, onUpdate, onRemove, days, cats, colorFunc }) => (
            <div className="bg-white p-5 rounded-[2rem] border border-stone-200 flex flex-wrap gap-5 items-center shadow-sm group hover:border-sky-200 transition-all">
                <div className="flex-1 min-w-[180px]">
                    <input className="w-full font-bold text-lg outline-none" value={item.name} onChange={e => onUpdate(item.id, 'name', e.target.value)} placeholder="Item Name" />
                    <div className="flex items-center gap-2 mt-1">
                        <div className="w-2 h-2 rounded-full" style={{ backgroundColor: colorFunc(item.category || 'General', 0) }}></div>
                        <select className="text-[9px] font-black uppercase text-stone-400 bg-transparent outline-none cursor-pointer" value={item.category || 'General'} onChange={e => onUpdate(item.id, 'category', e.target.value)}>
                            {cats.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                </div>
                <div className="flex items-center gap-2 bg-stone-50 px-3 py-2 rounded-xl border border-stone-100">
                    <span className="text-stone-400 font-bold">$</span>
                    <input className="w-20 font-black bg-transparent outline-none" type="number" value={item.amount || ''} onChange={e => onUpdate(item.id, 'amount', e.target.value)} placeholder="0" />
                </div>
                <div className="min-w-[150px]">
                    <select className="text-xs font-bold border border-stone-200 rounded-xl p-2 w-full mb-1 bg-white outline-none" value={item.freq} onChange={e => onUpdate(item.id, 'freq', e.target.value)}>
                        {['One-Time', 'Weekly', 'Bi-Weekly', 'Monthly', 'Quarterly'].map(f => <option key={f} value={f}>{f}</option>)}
                    </select>
                    <div className="text-[10px] space-y-1 mt-2">
                        {item.freq === 'Monthly' && <div className="flex items-center gap-1 font-bold text-stone-400 uppercase">Day: <input type="number" className="w-10 border border-stone-200 rounded text-center" value={item.day} onChange={e => onUpdate(item.id, 'day', e.target.value)} /></div>}
                        {item.freq === 'Weekly' && <select className="w-full border border-stone-200 rounded-lg font-bold uppercase p-0.5" value={item.dow} onChange={e => onUpdate(item.id, 'dow', e.target.value)}>{days.map(d => <option key={d}>{d}</option>)}</select>}
                        {['Bi-Weekly', 'Quarterly', 'One-Time'].includes(item.freq) && <div className="flex items-center gap-1 font-bold text-stone-400 uppercase">Start: <input type="date" className="border border-stone-200 rounded px-1" value={item.ref} onChange={e => onUpdate(item.id, 'ref', e.target.value)} /></div>}
                        <div className="flex items-center gap-1 font-bold text-rose-400 uppercase">Ends: <input type="date" className="border border-rose-100 rounded px-1" value={item.endDate || ''} onChange={e => onUpdate(item.id, 'endDate', e.target.value)} /></div>
                    </div>
                </div>
                <button onClick={() => { if(confirm("Permanently delete?")) onRemove(); }} className="text-stone-300 hover:text-rose-500 p-2"><Icon name="trash-2" size={20} /></button>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>

</body>
</html>